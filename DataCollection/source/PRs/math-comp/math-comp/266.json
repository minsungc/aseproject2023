{"author":"erikmd","number":266,"diff_summary":[{"file":".dockerignore","status":"A","additions":272,"deletions":12},{"file":".gitlab-ci.yml","status":"A","additions":272,"deletions":12},{"file":"Dockerfile","status":"A","additions":272,"deletions":12},{"file":"Dockerfile.make","status":"A","additions":272,"deletions":12},{"file":"README.md","status":"A","additions":272,"deletions":12},{"file":"mathcomp/algebra/opam","status":"A","additions":272,"deletions":12},{"file":"mathcomp/character/opam","status":"A","additions":272,"deletions":12},{"file":"mathcomp/field/opam","status":"A","additions":272,"deletions":12},{"file":"mathcomp/fingroup/opam","status":"A","additions":272,"deletions":12},{"file":"mathcomp/solvable/opam","status":"A","additions":272,"deletions":12},{"file":"mathcomp/ssreflect/opam","status":"A","additions":272,"deletions":12}],"state":"merged","open_date":"2018-12-20T18:47:34Z","update_date":"2019-01-15T09:43:00Z","discussion":[{"author":"erikmd","date":"2018-12-20T19:04:08Z","comment":"Sorry I just noticed a big typo crept in the .yml; I'll fix this in 1-2h max (currently on my phone without Git client...)"},{"author":"erikmd","date":"2018-12-20T20:06:03Z","comment":"Done.\r\nBTW I've changed the suggested manip to test this PR, see the **\"ToDo\"** paragraph of https://github.com/math-comp/math-comp/pull/266#issue-240267329\r\n\r\nCc @CohenCyril "},{"author":"erikmd","date":"2018-12-21T11:20:56Z","comment":"Hi @CohenCyril, there was a small bug for Coq 8.6 due to the exit code of `[ -n \"$sw\" ] && opam switch remove -y \"${sw}\"`, so I've replaced this with some regular `if-then-fi`. I also tweaked a few details (including the addition of a markdown badge).\r\n\r\nCyril, could you start a new branch build in the same way? (a force-push will certainly be required though)"},{"author":"Zimmi48","date":"2018-12-21T12:32:37Z","comment":"Regarding support for GitHub PR from forks, cf. coq/bot#23."},{"author":"erikmd","date":"2018-12-21T15:13:30Z","comment":"Hi @CohenCyril, the pipeline build was OK, cf. https://gitlab.com/math-comp/math-comp/pipelines/40996606;\r\nI guess you can now merge this PR in master? so we'll be able to check the additional `docker push` of the four mathcomp-master images to https://hub.docker.com/r/mathcomp/mathcomp-dev works as well…"},{"author":"erikmd","date":"2018-12-21T19:39:55Z","comment":"FYI I've just pushed a slight change for the GitLab Docker images naming convention:\r\n`registry.gitlab.com/math-comp/math-comp/branch-slug:iid_coq-version`, e.g.\r\n`registry.gitlab.com/math-comp/math-comp/master:3_coq-8.6`\r\n\r\n(Indeed GitLab CI basically [accepts](https://gitlab.com/math-comp/math-comp/container_registry) \"2 more slashes\" than Docker Hub images, e.g. `registry.gitlab.com/math-comp/math-comp/optional-name/optional-image-name:tag` would be OK)"},{"author":"erikmd","date":"2018-12-21T21:30:09Z","comment":"Hi, sorry I finally backtracked and removed my additional commit 64e0a090937694482a6dac1cf0e8e8b40f87aebc that was changing the GitLab images naming convention, as even if it would have facilitated the manual removing of images (requiring fewer clicks, only one per \"sub-repository\"), it would have removed the possibility to remove programmatically these \"sub-repositories\", given the endpoints provided in the [Docker Registry HTTP API](https://github.com/docker/distribution/blob/master/docs/spec/api.md) implemented in GitLab CI."},{"author":"erikmd","date":"2019-01-14T21:49:28Z","comment":"Hi @CohenCyril! do you agree to merge this?\r\n\r\nFYI the automatic deletion feature of the `registry.gitlab.com/math-comp/math-comp:1_master_coq-…` Docker images that I was mentioning earlier is not really necessary per se (it is rather something useful for GitLab CI servers themselves to scale more). Anyway, this feature is not directly available in GitLab CI API currently (there is an [open issue in gitlab-ce](https://gitlab.com/gitlab-org/gitlab-ce/issues/21608), so it could only be implemented using a kind of workaround for the time being).\r\n\r\nFor the record, after merging #266, you should also take care of:\r\n* configuring coqbot to automatically push PR branches to GitLab CI\r\n  (cf. the nice documentation prepared by @Zimmi48 in [this readme](https://github.com/coq/bot#rely-on-coqbot-to-synchronize-your-github-prs-with-your-gitlab-project))\r\n* and maybe disable Travis CI builds to avoid unnecessary redundancy… \r\n\r\nBest wishes for the new year! Erik"},{"author":"CohenCyril","date":"2019-01-15T09:43:16Z","comment":"Thanks Erik! Happy new year to you too."}],"review_discussion":[],"tags":[],"commits":[{"author":"erikmd","committer":"erikmd","hash":"1046da99d22462d6aeb23dd12043c2537f47abf1","message":"Move-and-rename opam files to the root folder\n\n* (Update make's path accordingly)\n* This patch is required for opam 2.0 pinning\n* As a result, these *.opam files are now similar to the opam files in\n  https://github.com/coq/opam-coq-archive/blob/master/extra-dev/packages/coq-mathcomp-*/coq-mathcomp-*.dev/","date":"2018-12-20T18:38:50Z"},{"author":"erikmd","committer":"erikmd","hash":"6fd03806214dccc7b54915da32299b9d6e64e5c7","message":"Avoid a warning regarding opam files\n\n\"\"\"\nFailed checks on coq-mathcomp-ssreflect package definition from source\n  at file:///home/coq/mathcomp/ssreflect:\n    error 57: Synopsis and description must not be both empty\n\"\"\"","date":"2018-12-20T18:38:50Z"},{"author":"erikmd","committer":"erikmd","hash":"036e10fc07ca816e9c0587e2bde55a2928c37388","message":"Add .dockerignore (partly whitelist-based, partly like .gitignore)","date":"2018-12-20T18:38:50Z"},{"author":"erikmd","committer":"erikmd","hash":"25630e23f09cd9c1b4b8bb9dbb2b3172111a92f1","message":"Add Dockerfile to build mathcomp using its opam files","date":"2018-12-21T11:17:07Z"},{"author":"erikmd","committer":"erikmd","hash":"3b654a62d7938e674e99a6bfd3823016db067bee","message":"Add Docker-based GitLab CI configuration\n\n* Design:\n  - build stage (e.g. docker build -t mathcomp-dev:$IID_$SLUG_coq-8.6 .)\n    - choice of the OCaml compiler: var OPAM_SWITCH in {base, edge}\n      (Dockerfile containing: \"opam switch set $compiler && eval $(opam env)\")\n    - master (protected branch) => push on GitLab registry and Docker Hub\n    - other branches (not tags) => push on GitLab registry\n    - Todo: GitHub PRs => push on GitLab\n  - test stage (image: mathcomp-dev:$IID_$SLUG_coq-8.6)\n    - script template foreach project (custom CONTRIB_URL, script)\n    - jobs foreach project and Coq version (custom COQ_VERSION, CONTRIB_VERSION)\n\n* Config for protected branches:\n  - set vars HUB_REGISTRY, HUB_REGISTRY_USER, HUB_REGISTRY_IMAGE, HUB_TOKEN\n\n* Remark:\n  - The name chosen for branches should ideally yield different values\n    of CI_COMMIT_REF_SLUG.\n  - But this is not mandatory as image tags start with \"${CI_PIPELINE_IID}_\".\n  cf. doc:\n  - CI_COMMIT_REF_NAME: The branch or tag name for which project is built.\n  - CI_COMMIT_REF_SLUG: $CI_COMMIT_REF_NAME lowercased, shortened to 63 bytes,\n    and with everything except 0-9 and a-z replaced with -.\n    No leading / trailing -. Use in URLs, host names and domain names.\n  - CI_PIPELINE_IID: The unique id of the current pipeline scoped to project.","date":"2018-12-21T11:17:07Z"},{"author":"erikmd","committer":"erikmd","hash":"1c14614a2328d1854fd584d8d7ca54121faec0ee","message":"Improve the mathcomp-dev Dockerfile (using Docker's multi-stage build)\n\n* Install coq-mathcomp-character in only 1 switch (cf. the build-arg $compiler)\n* Remove the other switch\n* Base the final image on coqorg/base:bare (which has no OCaml compiler layers)","date":"2018-12-21T11:17:07Z"},{"author":"erikmd","committer":"erikmd","hash":"da5985eae6656be1bd30aee76c8d08dbc3a09c25","message":"chore: s/.build/.opam-build/","date":"2018-12-21T11:17:07Z"},{"author":"erikmd","committer":"erikmd","hash":"ab8aefdcff6cf02e8cfe51bd052242f9907c5e72","message":"Add hidden job .make-build to also test the Makefile build infra\n\n* This job is only instantiated with coqorg/coq:latest\n* Add the associated Dockerfile.make","date":"2018-12-21T11:17:14Z"},{"author":"erikmd","committer":"erikmd","hash":"11c1489d8906ef62485b9b9d145f44acc4b9471a","message":"README.md: Add GitLab CI badge","date":"2018-12-21T11:17:14Z"}]}