{"author":"gares","number":433,"diff_summary":[{"file":".gitignore","status":"A","additions":213,"deletions":4},{"file":".gitlab-ci.yml","status":"A","additions":213,"deletions":4},{"file":"mathcomp/Make.test-suite","status":"A","additions":213,"deletions":4},{"file":"mathcomp/Makefile.common","status":"A","additions":213,"deletions":4},{"file":"mathcomp/Makefile.test-suite.coq.local","status":"A","additions":213,"deletions":4},{"file":"mathcomp/test_suite/output.v","status":"A","additions":213,"deletions":4},{"file":"mathcomp/test_suite/output.v.out","status":"A","additions":213,"deletions":4},{"file":"mathcomp/test_suite/output.v.out.8.7","status":"A","additions":213,"deletions":4},{"file":"mathcomp/test_suite/output.v.out.8.8","status":"A","additions":213,"deletions":4},{"file":"mathcomp/test_suite/output.v.out.8.9","status":"A","additions":213,"deletions":4}],"state":"merged","open_date":"2019-11-18T17:02:08Z","update_date":"2020-09-17T15:46:06Z","discussion":[{"author":"gares","date":"2019-11-18T17:11:33Z","comment":"For the reviewers:\r\n- please suggest other lemmas to be printed and scopes to be opened"},{"author":"gares","date":"2019-11-18T17:38:27Z","comment":"CI should test if coq/coq#11090 (that I used as the reference output) agrees with Coq 8.9.\r\nCoq 8.10 prints coercions, so there it will fail."},{"author":"pi8027","date":"2019-11-19T02:33:17Z","comment":"Also `mathcomp/Make.test-suite` have to be changed. Currently, the test-suite facility is invoked only from `make-coq-latest` and not invoked from `coq-8.9` and `coq-8.10` in CI. (see `Dockerfile.make` and `.gitlab-ci.yml`.)"},{"author":"ybertot","date":"2020-03-25T14:30:00Z","comment":"@gares, do you confirm that this PR should be in release 1.11"},{"author":"gares","date":"2020-03-26T16:04:18Z","comment":"We don't really care since it is not for the final user, it is for us and for the coq devs.\r\n\r\nBut I completely forgot about this PR, thanks for the heads up"},{"author":"CohenCyril","date":"2020-08-25T12:11:20Z","comment":"@gares I think this PR is of extreme importance to prevent Coq regressions going under the radar.\r\n@maximedenes can I assign you to \"torture\" @gares?"},{"author":"maximedenes","date":"2020-08-25T16:24:14Z","comment":"> can I assign you to \"torture\" @gares?\r\n\r\nSure, sounds like something I could do ;)"},{"author":"ejgallego","date":"2020-08-26T14:12:58Z","comment":"Note that if #316 is merged, dune does provide some built-in support for this "},{"author":"gares","date":"2020-09-07T14:39:57Z","comment":"I've revived this. It would be nice to have a second round of review on CI & Docker since I'm really not an expert there."},{"author":"CohenCyril","date":"2020-09-07T14:47:21Z","comment":"@erikmd would you mind taking a look?"},{"author":"erikmd","date":"2020-09-09T11:28:16Z","comment":"@CohenCyril yes, I plan to have a look today (otherwise ping me!)"},{"author":"gares","date":"2020-09-09T13:19:39Z","comment":"It requires some fixes. In particular you can provide a different output reference depending on the version of Coq (plus a default one). I must have messed things up, so the reference for 8.12 is OK, the default one is wrong (my intent was to have it for < 8.12) and the 8.13 reference is wrong as well. Anyway, fixing the reference files should be orthogonal to the infrastructure."},{"author":"erikmd","date":"2020-09-10T13:53:31Z","comment":"BTW, a related question:\r\nare you interested in keeping the generated files `test_suite/output.v.out.new` as build artifacts? (e.g., with an expiration of 1 month)"},{"author":"gares","date":"2020-09-10T14:07:01Z","comment":"the diff in the log is enough I guess, but why not.\r\n"},{"author":"erikmd","date":"2020-09-10T16:24:08Z","comment":"@gares\r\n\r\n> the diff in the log is enough I guess, but why not.\r\n\r\nOK so maybe it is unnecessary (otherwise you might want to add an `artifacts` spec after these `script` lines below)\r\n\r\n```yaml\r\n  script:\r\n    - cd mathcomp\r\n    - make test-suite \r\n  artifacts:\r\n    name: \"output-test_$CI_JOB_NAME\"\r\n    when: always\r\n    paths:\r\n      - mathcomp/test_suite/*.v.out.new\r\n    expire_in: 1 month\r\n```\r\n\r\nAnyway, don't forget to remove the line\r\n```\r\n- docker run --mount \"type=bind,source=$(pwd),target=/home/coq/mathcomp\" -w /home/coq/mathcomp -t \"${IMAGE}\" /bin/bash --login -c \"set -x; cd mathcomp; make test-suite\"\r\n```\r\n(which is subsumed by the `test-*` jobs)"},{"author":"erikmd","date":"2020-09-11T11:13:33Z","comment":"It seems there are two remaining issues:\r\n\r\n1. `make test-suite` rebuilds the whole mathcomp (instead of relying on the installed `.vo`s): https://gitlab.com/math-comp/math-comp/-/jobs/732817696#L188 (this is somewhat related to the (incomplete) change https://github.com/math-comp/math-comp/pull/433/commits/ff61778018f5eff362a50e48e5b3fd30dec962d2); I guess it might be desirable that an **environment variable** commands whether `make test-suite` behaves like this by default (rebuilding/testing the local `.v`s), or does not recompile the files and assume that e.g. `make install` has already be done (?)\r\n2. for some reason, the `diff` is performed with `test_suite/output.v.out` instead of `test_suite/output.v.out.8.9` (?): https://gitlab.com/math-comp/math-comp/-/jobs/732817696#L327"},{"author":"gares","date":"2020-09-11T12:04:06Z","comment":"For 1. I miss there the dependency is. Do you know? I'm fine with the env variable thing, but I could not find where to use it."},{"author":"gares","date":"2020-09-11T14:35:50Z","comment":"I think I found it. Let's see how CI goes"},{"author":"erikmd","date":"2020-09-11T20:26:43Z","comment":"Hi @gares,\r\n\r\nthe pipeline failed (so I cancelled it to avoid running the remaining jobs needlessly)\r\nbecause IIUC, the `all.vo` file is not installed by opam install.\r\n\r\ncf. https://gitlab.com/math-comp/math-comp/-/jobs/734043221\r\n```\r\n$ make test-suite TEST_SKIP_BUILD=1\r\nCOQBIN=/home/coq/.opam/4.07.1+flambda/bin/ ocaml ../etc/utils/hierarchy.ml -verify -R . mathcomp -lib all.all > test_suite/test_hierarchy_all.v\r\n/home/coq/.opam/4.07.1+flambda/bin/coq_makefile  -f Make.test-suite -o Makefile.test-suite.coq\r\nmake -f Makefile.test-suite.coq VDFILE=\".coqdeps.test-suite\" --no-print-directory\r\nCOQDEP VFILES\r\nmake[2]: *** No rule to make target 'all/all.vo', needed by 'test_suite/test_hierarchy_all.vo'.  Stop.\r\nmake[1]: *** [Makefile.test-suite.coq:339: all] Error 2\r\nmake: *** [Makefile.common:96: this-test-suite] Error 2\r\nERROR: Job failed: exit code 1\r\n```\r\n\r\nHopefully just reverting this commit https://github.com/math-comp/math-comp/commit/ff61778018f5eff362a50e48e5b3fd30dec962d2\r\n(and keeping your other change dealing with `TEST_SKIP_BUILD=1`) would be OK, to compile `all.vo` and *just* `all.vo`(?)"},{"author":"pi8027","date":"2020-09-11T21:24:39Z","comment":"I think it is acceptable to replace this `-lib all.all` with `-lib all_ssreflect -lib all_algebra ... -lib all_character` to avoid the issue with `all.vo`.\r\nhttps://github.com/math-comp/math-comp/blob/c2e7bad5c95a11f42f9f6d282ee2e5d84e27cbed/mathcomp/Makefile.common#L60"},{"author":"gares","date":"2020-09-12T15:36:50Z","comment":"I guess I need to remove the -R as well"},{"author":"pi8027","date":"2020-09-13T04:50:50Z","comment":"> I guess I need to remove the -R as well\r\n\r\n@gares Removing `-R . mathcomp` breaks the `test-suite` target (without installation). Should we rather pass the `COQLIBS` variable of `Makefile.test-suite.coq` to `hierarchy.ml` and use it to locate libraries?"},{"author":"gares","date":"2020-09-14T11:49:20Z","comment":"I've the impression that the `Make.test-suite` is not designed work in both local and system wide modes.\r\n\r\nWhat one could do is to have the file contain no `-R` and, depending on the mode (a variable), invoke `coq_makefile -f Make.test-suite -R . mathcomp` or `coq_makefile -f Make.test-suite -R test_suite mathcomp.test_suite`.\r\n\r\nIs what you propose simpler/cleaner? (I'm not sure I get it)"},{"author":"gares","date":"2020-09-14T18:17:41Z","comment":"This looks finally ready for squash+merge!"},{"author":"erikmd","date":"2020-09-14T20:31:12Z","comment":":+1:\r\nand the night after the squash+merge, we'll just need to check that the new job `test-coq-dev` is properly triggered in the scheduled [pipeline](https://gitlab.com/math-comp/math-comp/-/pipelines)."},{"author":"CohenCyril","date":"2020-09-15T13:39:16Z","comment":"Before merge I have few questions : how many tests should we perform? Would it be possible to test intermediate statements? (i.e. after application of a few tactics).\r\n"},{"author":"gares","date":"2020-09-15T15:09:01Z","comment":"> Before merge I have few questions : how many tests should we perform? Would it be possible to test intermediate statements? (i.e. after application of a few tactics).\r\n\r\nHow many I don't know, the only limit is about maintenance, if the statement changes or Coq changes (while staying correct) then the test reference output may need an update.\r\n\r\nYes, just start a proof and write `Show.` when you feel like the goal is interesting."},{"author":"gares","date":"2020-09-15T15:13:46Z","comment":"As a start it would help to have some tests covering rings, polynomials, lattices and matrices for example, since the statement I picked covers many group stuff, some set and seq stuff as well, but not much more. But not in this PR ;-)"},{"author":"gares","date":"2020-09-16T08:35:59Z","comment":"ping @maximedenes "},{"author":"CohenCyril","date":"2020-09-17T15:46:02Z","comment":"OK! I'm taking the lead and merging."}],"review_discussion":[{"author":"pi8027","file":"mathcomp/Makefile.coq.local","date":"2019-11-18T23:23:12Z","comment":"This should be placed at `Makefile.test-suite.local`. Currently, the use of `coq_makefile` is split into two parts: the library and test-suite, because generating `test_suite/hierarchy_test.v` requires `all/all.vo`."},{"author":"erikmd","file":"mathcomp/Makefile.test-suite.coq.local","date":"2020-09-10T11:54:08Z","comment":"These two lines could be simplified/merged, doing just:\r\n\r\n```suggestion\r\n\t  if ! diff -q \"$$REFERENCE\" \"$$f.out.new\"; \\\r\n```"},{"author":"erikmd","file":"mathcomp/Makefile.test-suite.coq.local","date":"2020-09-10T11:55:55Z","comment":"Then this `echo` becomes unnecessary (`diff -q something something_else` already prints:\r\n\"Files something something_else differ\")\r\n\r\n```suggestion\r\n\t    then diff -u \"$$REFERENCE\" \"$$f.out.new\"; \\\r\n```"},{"author":"erikmd","file":".gitlab-ci.yml","date":"2020-09-10T12:04:23Z","comment":"This command works but the place where it is run is suboptimal. More precisely:\r\nIt runs `make test-suite` (existing tests + notation test) for each version of Coq, which is very fine, but these tests should ideally be separated from the build job to \"separate concerns\", so that:\r\n\r\n* the other stages don't wait too much to be started (otherwise it would take [42'](https://gitlab.com/math-comp/math-comp/-/jobs/729111262) while it used to take [26'](https://gitlab.com/math-comp/math-comp/-/jobs/730243138)),\r\n* and a failure in this new notation test won't prevent other tests to be run.\r\n\r\nHowever, the change I suggest (cf. my main review post) should not prevent running these tests in the nightly build, so that we can be aware of any unexpected notation change from coq.dev."},{"author":"erikmd","file":"mathcomp/Makefile.test-suite.coq.local","date":"2020-09-10T12:07:55Z","comment":"it seems [from the log](https://gitlab.com/math-comp/math-comp/-/jobs/729111262) that mathcomp is needlessly recompiled twice.\r\n\r\nI guess you should just remove the `all/all.vo` prerequisite, so that the `test_suite/output.v` compilation will rely on the existing build of mathcomp (installed by the CI job using opam)\r\n\r\n```suggestion\r\n$(OUTPUT_ARTIFACTS): %.v.out.new: %.v\r\n```"},{"author":"erikmd","file":"mathcomp/Makefile.test-suite.coq.local","date":"2020-09-11T11:26:21Z","comment":"@gares \r\nI've just found the origin of issue 2. mentioned in https://github.com/math-comp/math-comp/pull/433#issuecomment-691033191 (variable name clash)\r\n\r\n```suggestion\r\nCOQ_VERSION_MINOR=$(shell $(COQC) -print-version | cut -d ' ' -f 1 | cut -d '.' -f 1-2)\r\n\r\n# Given a file f we compare its compilation output f.out.new with\r\n# f.out.COQ_VERSION_MINOR (or f.out if f.out.COQ_VERSION_MINOR does not exist)\r\npost-all:: $(OUTPUT_ARTIFACTS)\r\n\t@for f in $(OUTPUT_TESTS); do\\\r\n\t  if [ -e \"$$f.out.$(COQ_VERSION_MINOR)\" ]; then REFERENCE=\"$$f.out.$(COQ_VERSION_MINOR)\";\\\r\n```"}],"tags":[{"tag":"kind: CI","description":"Issue or PR about the CI. (Gitlab CI or CI of dependencies problems linked with math-comp)"}],"commits":[{"author":"gares","committer":"gares","hash":"bc0a71056c24b29c8289395ee01740bb2ef7ad8d","message":"[test suite] infrastructure to test how some statements are printed","date":"2020-09-07T14:34:30Z"},{"author":"gares","committer":"gares","hash":"c0214cdb4a44261db539b48fb76dbdaded87312b","message":"default reference file for < 8.12","date":"2020-09-09T13:22:29Z"},{"author":"gares","committer":"web-flow","hash":"8bfcb13c1576a8d6e55dc7c732ec3bda5f5e4f7d","message":"Update mathcomp/Makefile.test-suite.coq.local\n\nCo-authored-by: Erik Martin-Dorel <erik@martin-dorel.org>","date":"2020-09-10T13:05:49Z"},{"author":"gares","committer":"web-flow","hash":"18edef73cdf0fb6671dbfb2e9d5829182a065919","message":"Update mathcomp/Makefile.test-suite.coq.local\n\nCo-authored-by: Erik Martin-Dorel <erik@martin-dorel.org>","date":"2020-09-10T13:06:07Z"},{"author":"gares","committer":"web-flow","hash":"ff61778018f5eff362a50e48e5b3fd30dec962d2","message":"Update mathcomp/Makefile.test-suite.coq.local\n\nCo-authored-by: Erik Martin-Dorel <erik@martin-dorel.org>","date":"2020-09-10T13:06:33Z"},{"author":"gares","committer":"gares","hash":"c7b1927d8072040d573757d543e2355e8280b9ee","message":"new attempt","date":"2020-09-10T15:45:13Z"},{"author":"gares","committer":"gares","hash":"39d3e313614d33b353978847f8d00d3fa2f2428f","message":"fix","date":"2020-09-10T15:49:43Z"},{"author":"gares","committer":"gares","hash":"8d17e971db2d29fad93443e730ee378ec768ba68","message":"rm docker run","date":"2020-09-11T07:49:04Z"},{"author":"gares","committer":"gares","hash":"f3ad9538962cd36d90ea3a6724125f448d7c0b10","message":"fix 8.9, 8.8 and 8.7","date":"2020-09-11T07:53:53Z"},{"author":"gares","committer":"gares","hash":"4c35b309ece8c57088dffd7bea0ef7878f1d8d12","message":"coq 8.13 does not exists yet","date":"2020-09-11T08:35:45Z"},{"author":"gares","committer":"web-flow","hash":"bcbf0850d771c889431fb8d3c073c41059268c05","message":"Update mathcomp/Makefile.test-suite.coq.local\n\nCo-authored-by: Erik Martin-Dorel <erik@martin-dorel.org>","date":"2020-09-11T11:55:40Z"},{"author":"gares","committer":"gares","hash":"a28ed91e0d3b2d03940c9b930ac516f0769f7e17","message":"avoid rebuild","date":"2020-09-11T20:34:58Z"},{"author":"gares","committer":"gares","hash":"cfa21928a5148f826e19aa5a78b83b5ed4e165b9","message":"avoid all.vo","date":"2020-09-12T11:24:47Z"},{"author":"gares","committer":"gares","hash":"755068fd34f0fa1e918123c4859aef2e89bedfca","message":"test-suite works both in local and system wide mode","date":"2020-09-14T11:58:24Z"},{"author":"gares","committer":"gares","hash":"38b28c7d9756da7d346a1866a4ce712b1c3472af","message":"don't use all.v in output.v","date":"2020-09-14T16:55:29Z"}]}