{"author":"hivert","number":793,"diff_summary":[{"file":"CHANGELOG_UNRELEASED.md","status":"M","additions":170,"deletions":3},{"file":"mathcomp/ssreflect/order.v","status":"M","additions":170,"deletions":3}],"state":"merged","open_date":"2021-10-01T20:39:23Z","update_date":"2021-10-22T11:38:09Z","discussion":[{"author":"hivert","date":"2021-10-01T21:05:14Z","comment":"There something wrong with multinomials but I don't thing it's related to this PR."},{"author":"hivert","date":"2021-10-03T20:29:44Z","comment":"Thanks @proux01 for the careful review !"},{"author":"hivert","date":"2021-10-04T08:30:56Z","comment":"Any confirmation that the failing of multinomials is not due to me ?"},{"author":"proux01","date":"2021-10-04T08:41:04Z","comment":"Indeed it's actually due to multinomials using dune which prompted math-comp/multinomials#45 which requires `/usr/bin/env` that doesn't seem available in nix. That's definitely unrelated."},{"author":"erikmd","date":"2021-10-14T17:11:52Z","comment":"> Indeed it's actually due to multinomials using dune which prompted [math-comp/multinomials#45](https://github.com/math-comp/multinomials/pull/45) which requires `/usr/bin/env` that doesn't seem available in nix. That's definitely unrelated.\r\n\r\n@CohenCyril is there something to do upstream in multinomials to this aim? e.g., replacing `/usr/bin/env bash` in the configure script with `/bin/bash`?"},{"author":"proux01","date":"2021-10-15T09:56:58Z","comment":"> @CohenCyril is there something to do upstream in multinomials to this aim? e.g., replacing `/usr/bin/env bash` in the configure script with `/bin/bash`?\r\n\r\n@erikmd no, that wouldn't help, @CohenCyril fixed the nixpkg package https://github.com/NixOS/nixpkgs/pull/140150 so there is nothing to do, this should now work"},{"author":"CohenCyril","date":"2021-10-15T16:01:38Z","comment":"> @CohenCyril is there something to do upstream in multinomials to this aim? e.g., replacing `/usr/bin/env bash` in the configure script with `/bin/bash`?\r\n\r\nThe failure of multinomials is now on the docker side. I'm ignoring for now."},{"author":"CohenCyril","date":"2021-10-15T22:01:47Z","comment":"> The failure of multinomials is now on the docker side. I'm ignoring for now.\r\n\r\nAh nevermind there is also a failure on the nix side, just for coq 8.12, which I do not understand...\r\nhttps://github.com/math-comp/math-comp/pull/793/checks?check_run_id=3905504301#step:12:22\r\n"},{"author":"erikmd","date":"2021-10-18T20:31:43Z","comment":"> Ah nevermind there is also a failure on the nix side, just for coq 8.12, which I do not understand... https://github.com/math-comp/math-comp/pull/793/checks?check_run_id=3905504301#step:12:22\r\n\r\nHi @CohenCyril, I've just have a look and I don't know either what's the meaning of\r\n```\r\nError: Library \"coq.kernel\" not found.\r\n```\r\nas this seems to be a dune-related error…\r\n\r\nBut I see that two lines above this error, there is:\r\n```\r\ncoq-native support enabled!\r\n```\r\nwhile I believe (IINM) that in the Nix packaging of multinomials, native compilation was expected to be off.\r\n\r\nSo if the error and this flag were related, I believe I have a simple solution that wouldn't require a change in multinomials codebase, just in the Nix packaging of `coq-mathcomp-multinomials.{dev & upcoming releases 1.5.5+}`:\r\n\r\nactually, the only purpose of the 50-line configure script I had proposed in multinomials is [this if-then-else](https://github.com/math-comp/multinomials/blob/348222aeee8ce02f84fc1ceaf1ff4f286cd29db1/configure#L39-L44):\r\n```\r\n    if coq_native_compiler; then\r\n        echo 'coq-native support enabled!' >&2\r\n        sed -e 's/;coq-native-disabled; \\?//' \"$dir/src/dune.in\" > \"$dir/src/dune\"\r\n    else\r\n        cat \"$dir/src/dune.in\" > \"$dir/src/dune\"\r\n    fi\r\n```\r\nAdmittedly, the coq_native_compiler condition is more strict for Coq 8.12.1 (the minimal version of Coq that is compatible with the `(mode native)` of dune ≥ 2.8), because of several reasons (briefly speaking, the 'COQ_NATIVE_COMPILER_DEFAULT=yes' string that can output `coqc -config` cannot be found in Coq <8.13, and we cannot do some opam query to see if the \"coq-native\" package has been installed, precisely given this detection/guess has to be done by the build system layer, agnostic w.r.t. the chosen package manager).\r\n\r\nBut, if you confirm that the Nix packaging need not enabling the `-native-compiler yes` option, a simple solution could be to replace the `./configure` Nix build step with just `cp -f src/dune.in src/dune`\r\n\r\nI'm not Nix-savvy at all, but hopefully this is feasible in https://github.com/CohenCyril/nixpkgs/blob/master/pkgs/development/coq-modules/multinomials/default.nix ? (this way, as I said just now, it wouldn't require another change in multinomials.dev)"},{"author":"CohenCyril","date":"2021-10-19T08:32:15Z","comment":"> while I believe (IINM) that in the Nix packaging of multinomials, native compilation was expected to be off.\r\n\r\nThis I'm not sure, since I do not understand where it comes from... Why would it be expected to be off?"},{"author":"proux01","date":"2021-10-21T11:59:15Z","comment":"> I don't know either what's the meaning of\r\n> \r\n> ```\r\n> Error: Library \"coq.kernel\" not found.\r\n> ```\r\n> \r\n> as this seems to be a dune-related error…\r\n\r\nIf this can shed some light, this happens only when native compilation is enabled, then dune need the OCaml library `coq.kernel` to be able to build the native OCaml code. That doesn't explain why it is not found though.\r\n\r\n> But, if you confirm that the Nix packaging need not enabling the `-native-compiler yes` option, a simple solution could be to replace the `./configure` Nix build step with just `cp -f src/dune.in src/dune`\r\n\r\nI guess native compilation with dune didn't get any serious testing in nix. Meanwhile, I'd rather be in favor of your solution (this configure script being already a workaround for a dune deficiency anyway).\r\n"},{"author":"proux01","date":"2021-10-22T08:12:13Z","comment":"@hivert could you rebase on master, CI should now be fixed (apologies for the inconvenience)"},{"author":"CohenCyril","date":"2021-10-22T08:55:41Z","comment":"> @hivert could you rebase on master, CI should now be fixed (apologies for the inconvenience)\r\n\r\nWait 1h please"},{"author":"hivert","date":"2021-10-22T09:44:58Z","comment":"@CohenCyril I didn't see your message before pushing. I hope I didn't rebase too soon."},{"author":"CohenCyril","date":"2021-10-22T09:46:51Z","comment":"> @CohenCyril I didn't see your message before pushing. I hope I didn't rebase too soon.\r\n\r\nYou did, please rebase again now."},{"author":"hivert","date":"2021-10-22T09:50:42Z","comment":"> You did, please rebase again now.\r\n\r\nDone"}],"review_discussion":[{"author":"proux01","file":"CHANGELOG_UNRELEASED.md","date":"2021-10-03T10:57:48Z","comment":"```suggestion\r\n    `subEsubset`, `complEsubset` to translate generic symbols to the\r\n```"},{"author":"proux01","file":"mathcomp/ssreflect/order.v","date":"2021-10-03T10:58:05Z","comment":"```suggestion\r\n```"},{"author":"proux01","file":"mathcomp/ssreflect/order.v","date":"2021-10-03T10:58:25Z","comment":"```suggestion\r\n```"},{"author":"proux01","file":"mathcomp/ssreflect/order.v","date":"2021-10-03T10:58:41Z","comment":"```suggestion\r\n```"},{"author":"proux01","file":"mathcomp/ssreflect/order.v","date":"2021-10-03T10:58:54Z","comment":"```suggestion\r\n```"},{"author":"CohenCyril","file":"mathcomp/ssreflect/order.v","date":"2021-10-04T08:41:19Z","comment":"This setup prevents using `{subset T}` when `T` has type `Type` but is canonically a `finType`. Please mimick the definition in `finset.v` to generalize the notation using a phantom type."},{"author":"hivert","file":"mathcomp/ssreflect/order.v","date":"2021-10-04T10:11:14Z","comment":"This should be done now. I wasn't sure about the notation `{subset T}` so that I forgot to goes all the way to set it up properly. I guess you agree with it since you didn't comment."}],"tags":[{"tag":"kind: enhancement","description":"Issue or PR about addition of features."}],"commits":[{"author":"hivert","committer":"hivert","hash":"745c30476db5d9982c63a374f8440aed3b54dc8b","message":"Canonical order structures on {set T}","date":"2021-10-22T09:50:03Z"}]}