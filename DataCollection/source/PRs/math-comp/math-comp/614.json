{"author":"erikmd","number":614,"diff_summary":[{"file":".gitlab-ci.yml","status":"M","additions":49,"deletions":38}],"state":"merged","open_date":"2020-10-12T11:50:04Z","update_date":"2020-11-09T16:50:03Z","discussion":[{"author":"chdoc","date":"2020-11-04T14:28:48Z","comment":"@erikmd @CohenCyril could one of you suggest an assignee? \r\n\r\n@erikmd I'm not sure I understand the (potential) impact of this change and how it is related to the \"overall aim\". Could you provide a bit more explanation/information for those on the mathcomp side who don't deal with Docker and CI pipelines all day long? (I assume I'm not speaking solely for myself here.) :man_shrugging: "},{"author":"erikmd","date":"2020-11-05T00:07:46Z","comment":"Hi @chdoc,\r\n> Could you provide a bit more explanation/information\r\n\r\nSure. Indeed the description was a bit terse… I'm going to elaborate on it soon (if it's still pending on Friday, feel free to ping me!)"},{"author":"chdoc","date":"2020-11-06T19:57:43Z","comment":"@erikmd PING! (Friday is nearing it's end)\r\n\r\n@CohenCyril @gares could one of you self-assign or suggest an assignee? This is the last PR milestoned for 1.12.0 that does not have an assignee. "},{"author":"erikmd","date":"2020-11-07T02:44:07Z","comment":"[sorry, I mis-clicked and sent my comment too early]"},{"author":"erikmd","date":"2020-11-07T03:04:05Z","comment":"Thanks @chdoc, so here is the wrap-up :)\r\n\r\n## The \"overall aim\" is two-fold:\r\n\r\n1. ensure that the mathcomp.dev image obtained by\r\n\r\n    ```\r\n    docker pull mathcomp/mathcomp-dev:coq-dev\r\n    ```\r\n    always brings **the latest coq master** (and not just the last nightly build).\r\n\r\n2. ensure that beyond this automatic deployment, math-comp's CI still runs the test-suite on coq-dev (to **detect regressions**).\r\n\r\nNote that point 2. is related to the recent CI enhancement done in @gares' PR https://github.com/math-comp/math-comp/pull/433\r\n\r\nPoint 1. is not directly performed by this PR #614, but this PR is a necessary ingredient for fully implementing the new architecture of the coq/docker-coq/docker-mathcomp CI/CD that we discussed recently with @Zimmi48, to get rid of the \"nightly-build limitation\" of docker images of coq & mathcomp.\r\n\r\n### To sum up, the old architecture was as follows:\r\n\r\n![2020-11_math-comp-before-pr614](https://user-images.githubusercontent.com/10367254/98430180-0ed16600-20ac-11eb-8977-e45c3bba8f49.png)\r\n\r\n### And the new architecture is as follows:\r\n\r\n![2020-11_math-comp-using-pr614](https://user-images.githubusercontent.com/10367254/98430202-45a77c00-20ac-11eb-91d5-080da46bd32b.png)\r\n\r\n## Regarding the positioning of this PR #614:\r\n\r\nAs shown above in the figures, a key change is that the automatically triggered pipeline in math-comp CI from coq-community CI **cannot be a scheduled pipeline**. Hence the use of a special environment variable `CRON_MODE`.\r\n\r\nThis is the core change of this PR.\r\n\r\nIt also does one refactoring and a small fix :\r\n\r\n1. Use only:refs, except:refs (no change intended, but replace old GitLab syntax with GitLab 10.0+ syntax)\r\n\r\n2. Fix (to have better clarity in the GitLab CI deployment browser) the environment deployment names related to the `deploy` stage jobs for the `master` protected branch (see the commit message for more details if need be).\r\n\r\n## Additional details\r\n\r\nFYI I've just tested the behavior of this PR on a temporary separate repo: https://gitlab.com/erikmd/math-comp-ci-preflight\r\n\r\nThe main thing that had to be checked was *whether the created stages and jobs were OK* in the following three configurations:\r\n\r\n* pr-0 (non-protected branch) → **full** build+test [(url)](https://gitlab.com/erikmd/math-comp-ci-preflight/-/pipelines/213003576)\r\n* master (protected branch), regular pipeline → **full** build+deploy+test [(url)](https://gitlab.com/erikmd/math-comp-ci-preflight/-/pipelines/213003062)\r\n* master (protected branch), regular pipeline triggered with CRON_MODE → **coq-dev** build+deploy+test [(url)](https://gitlab.com/erikmd/math-comp-ci-preflight/-/pipelines/213003632)"},{"author":"erikmd","date":"2020-11-07T23:36:41Z","comment":"@CohenCyril I've just proposed you'd be the assignee of this PR\r\n(but I was unsure if that triggered a notification, hence this comment :)"},{"author":"CohenCyril","date":"2020-11-08T00:21:31Z","comment":"Thanks @erikmd!! I'll merge on monday, in the morning, so that if a failure occur we can fix it within the day."},{"author":"erikmd","date":"2020-11-09T16:42:50Z","comment":"Hi @CohenCyril, do you believe you could merge #614 today? otherwise no worries! tomorrow morning would be very fine."},{"author":"CohenCyril","date":"2020-11-09T16:50:01Z","comment":"> Hi @CohenCyril, do you believe you could merge #614 today? otherwise no worries! tomorrow morning would be very fine.\r\n\r\nI will now!"}],"review_discussion":[],"tags":[],"commits":[{"author":"erikmd","committer":"erikmd","hash":"8338973e2741baf7f9bbfd3bbcf5982c3963830c","message":"feat: Update only/except rules\n\n* Use only:refs, except:refs (available since GitLab 10.0)\n\n* Add except:variables/($CRON_MODE == \"nightly\")\n  so coqbot can trigger the jobs currently chosen for scheduled pipelines,\n  with a regular pipeline on master with variable CRON_MODE := nightly\n\n* Overall aim: rebuild coqorg/coq:dev & mathcomp/mathcomp-dev:coq-dev\n  on GitLab CI after each successful update of coq.dev, using coqbot.","date":"2020-10-12T11:48:55Z"},{"author":"erikmd","committer":"erikmd","hash":"8da589737cbb81889c26037eeed856f8a00ff667","message":"fix: Deploy each image w.r.t. a separate GitLab CI environment name\n\nto fully benefit from the \"forward_deployment_failure\" feature\ncf. https://docs.gitlab.com/ee/ci/environments/deployment_safety.html#skip-outdated-deployment-jobs\n\nRemark on environment names:\n> Caution: Some characters are not allowed in environment names. Use\n> only letters, numbers, spaces, and '-', '_', '/', '{', '}', or '.'.\n> Also, it must not start nor end with '/'.\ncf. https://docs.gitlab.com/ee/ci/environments/index.html","date":"2020-11-07T01:44:21Z"}]}